{
    "collab_server" : "",
    "contents" : "---\ntitle: \"project\"\nauthor: \"Yilin Gao\"\ndate: \"May 1, 2017\"\noutput: html_document\n---\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\n```\n\n```{r packages}\nlibrary(dplyr)\nlibrary(corrplot)\nlibrary(forcats)\nlibrary(randomForest)\nlibrary(gbm)\n```\n\n## Load and clean data\n\n```{r load data}\nload(\"ames_train.Rdata\")\nload(\"ames_test.Rdata\")\nload(\"ames_validation.Rdata\")\n```\n\n```{r data cleaing}\ntrain = ames_train %>% \n  mutate(datset = \"train\")\ntest = ames_test %>%\n  mutate(datset = \"test\")\nvalid = ames_validation %>%\n  mutate(datset = \"valid\")\n\ndat = train %>% \n  rbind(., test) %>%\n  rbind(., valid)\n\nfindNA = function(col){\n  numNA = sum(is.na(col) | col == \"\")\n  type = class(col)\n  level = paste(as.character(levels(col)), collapse = \";\")\n  large_0 = sum(table(col) > 0)\n  return(c(numNA, type, level, large_0))\n}\n\ntrain_info = lapply(dat, findNA)\ntrain_info = as.data.frame(do.call(rbind, train_info), stringsAsFactors = F)\ncolnames(train_info) = c(\"numNA\", \"class\", \"level\")\ntrain_info$numNA = as.numeric(train_info$numNA)\ntrain_info$missing_ratio = train_info$numNA/nrow(ames_train)\ntrain_info$names = rownames(train_info)\n\n\ndat1 = dat\n\n# Bsmt.Exposure\ndat1$Bsmt.Exposure[dat1$Bsmt.Exposure == \"\" &\n                     !is.na(dat1$Bsmt.Exposure)] = names(sort(table(dat1$Bsmt.Exposure), \n                                                              decreasing = T))[1]\ndat1$Mas.Vnr.Type[dat1$Mas.Vnr.Type == \"\"] = \"None\"\ndat1$Electrical[dat1$Electrical == \"\"] = names(sort(table(dat1$Electrical),\n                                                    decreasing = T))[1]\ndat1$BsmtFin.Type.2[dat1$BsmtFin.Type.2 == \"\" &\n                      !is.na(dat1$BsmtFin.Type.2)] = NA\n\ndat2 = dat1 %>%\n  dplyr::select(-Garage.Yr.Blt) %>%\n  filter(PID != 903426160) %>%\n  mutate(MS.SubClass = as.factor(MS.SubClass),\n         Lot.Frontage = ifelse(is.na(Lot.Frontage), 0, Lot.Frontage),\n         Alley = fct_explicit_na(Alley, \"Unknown\"),\n         Pool.QC = fct_explicit_na(Pool.QC, \"Unknown\"),\n         Pool.QC = as.numeric(factor(Pool.QC,\n                                     levels = c(\"Unknown\", \"Fa\", \n                                                    \"TA\", \"Gd\", \"Ex\"))),\n         Fence = fct_explicit_na(Fence, \"Unknown\"),\n         Fence = as.numeric(factor(Fence,\n                                     levels = c(\"Unknown\", \"MnWw\", \"GdWo\", \n                                                    \"MnPrv\", \"GdPrv\"))),\n         Misc.Feature = fct_explicit_na(Misc.Feature, \"Unknown\"),\n         Fireplace.Qu = fct_explicit_na(Fireplace.Qu, \"Unknown\"),\n         Fireplace.Qu = as.numeric(factor(Fireplace.Qu,\n                                          levels = c(\"Unknown\", \"Po\", \"Fa\",\n                                                     \"TA\", \"Gd\", \"Ex\"))),\n         Garage.Cond = fct_explicit_na(Garage.Cond, \"Unknown\"),\n         Garage.Cond = as.numeric(factor(Garage.Cond, \n                                         levels = c(\"Unknown\", \"Po\", \"Fa\", \n                                                    \"TA\", \"Gd\", \"Ex\"))),\n         Garage.Qual = fct_explicit_na(Garage.Qual, \"Unknown\"),\n         Garage.Qual = as.numeric(factor(Garage.Qual, \n                                         levels = c(\"Unknown\", \"Po\", \"Fa\", \n                                                    \"TA\", \"Gd\", \"Ex\"))),\n         Garage.Type = fct_explicit_na(Garage.Type, \"Unknown\"),\n         Garage.Finish = fct_explicit_na(Garage.Finish, \"Unknown\"),\n         Garage.Finish = as.numeric(factor(Garage.Finish, \n                                           levels = c(\"Unknown\", \"Unf\", \n                                                      \"RFn\", \"Fin\"))),\n         Bsmt.Qual = fct_explicit_na(Bsmt.Qual, \"Unknown\"),\n         Bsmt.Qual = as.numeric(factor(Bsmt.Qual, \n                                       levels = c(\"Unknown\", \"Po\", \"Fa\", \n                                                  \"TA\", \"Gd\", \"Ex\"))),\n         Bsmt.Cond = fct_explicit_na(Bsmt.Cond, \"Unknown\"),\n         Bsmt.Cond = as.numeric(factor(Bsmt.Cond, \n                                       levels = c(\"Unknown\", \"Po\", \"Fa\", \n                                                  \"TA\", \"Gd\", \"Ex\"))),\n         Bsmt.Exposure = fct_explicit_na(Bsmt.Exposure, \"Unknown\"),\n         Bsmt.Exposure = as.numeric(factor(Bsmt.Exposure, \n                                           levels = c(\"Unknown\", \"No\", \"Mn\", \n                                                      \"Av\", \"Gd\"))),\n         BsmtFin.Type.1 = fct_explicit_na(BsmtFin.Type.1, \"Unknown\"),\n         BsmtFin.Type.1 = as.numeric(factor(BsmtFin.Type.1, \n                                            levels = c(\"Unknown\", \"Unf\",\"LwQ\",\n                                                       \"Rec\", \"BLQ\", \n                                                       \"ALQ\", \"GLQ\"))),\n         BsmtFin.Type.2 = fct_explicit_na(BsmtFin.Type.2, \"Unknown\"),\n         BsmtFin.Type.2 = as.numeric(factor(BsmtFin.Type.2, \n                                            levels = c(\"Unknown\", \"Unf\",\"LwQ\",\n                                                       \"Rec\", \"BLQ\", \n                                                       \"ALQ\", \"GLQ\"))),\n         Mas.Vnr.Area = ifelse(is.na(Mas.Vnr.Area), 0, Mas.Vnr.Area),\n         Utilities = as.numeric(factor(Utilities, \n                                       levels = c(\"ELO\",\"NoSeWa\",\"NoSewr\",\"AllPub\"))),\n         Lot.Shape = as.numeric(factor(Lot.Shape, \n                                       levels = c(\"IR3\",\"IR2\",\"IR1\",\"Reg\"))),\n         Exter.Qual= as.numeric(factor(Exter.Qual, \n                                       levels = c(\"Po\", \"Fa\", \n                                                  \"TA\", \"Gd\", \"Ex\"))),\n         Land.Slope =  as.numeric(factor(Land.Slope, \n                                         levels = c(\"Sev\", \"Mod\",\"Gtl\"))),\n         Exter.Cond = as.numeric(factor(Exter.Cond, \n                                        levels = c(\"Po\", \"Fa\", \n                                                   \"TA\", \"Gd\", \"Ex\"))),\n         Heating.QC = as.numeric(factor(Heating.QC, \n                                        levels = c(\"Po\", \"Fa\", \n                                                   \"TA\", \"Gd\", \"Ex\"))),\n         Electrical = as.numeric(factor(Electrical, \n                                        levels = c(\"Mix\", \"FuseP\", \n                                                   \"FuseF\", \"FuseA\", \"SBrkr\"))),\n         Kitchen.Qual = as.numeric(factor(Kitchen.Qual, \n                                          levels = c(\"Po\", \"Fa\", \n                                                     \"TA\", \"Gd\", \"Ex\"))),\n         Functional = as.numeric(factor(Functional, \n                                        levels = c(\"Sal\", \"Sev\", \n                                                   \"Maj2\", \"Maj1\", \"Mod\",\n                                                   \"Min2\",\"Min1\",\"Typ\"))),\n         Paved.Drive = as.numeric(factor(Paved.Drive, \n                                         levels = c(\"N\", \"P\",\"Y\"))),\n         Bsmt.Half.Bath = ifelse(is.na(Bsmt.Half.Bath), 0, Lot.Frontage),\n         Bsmt.Full.Bath = ifelse(is.na(Bsmt.Full.Bath), 0, Lot.Frontage)\n  )\n\ndat3 = dat2 %>%\n  dplyr::select(-Condition.2)  # different levels in training and testing data\n\ntrain_clean = dat3[dat3$datset == \"train\",] %>%\n  dplyr::select(-datset)\ntest_clean = dat3[dat3$datset == \"test\",] %>%\n  dplyr::select(-datset)\nvalidation_clean = dat3[dat3$datset == \"valid\",] %>%\n  dplyr::select(-datset)\n```\n\n```{r functions, echo=FALSE}\ncheck = function(pred, true_value){\n  return(data.frame(RMSE = RMSE(pred[,1],true_value),\n                    BIAS = BIAS(pred[,1],true_value),\n                    maxDeviation = maxDeviation(pred[,1],true_value),\n                    MeanAbsDeviation = MeanAbsDeviation(pred[,1],true_value),\n                    Coverage = coverage(pred[,2], pred[,3], true_value)))\n}\nRMSE = function(y,pred) {\n  rmse = sqrt(mean((y-pred)^2))\n  return(rmse)\n}\n\nBIAS = function(pred, true_value){\n  return(mean(pred-true_value))\n}\nmaxDeviation = function(pred, true_value){\n  return(max(abs(pred-true_value)))\n}\nMeanAbsDeviation = function(pred, true_value){\n  return(mean(abs(pred-true_value)))\n}\ncoverage = function(lwr,upr,true_value){\n  mean(lwr<true_value & true_value<upr)\n}\n```\n\n## Data Description plots\n\n```{r distribution of price, echo=FALSE}\npng(width=900, pointsize=15, filename = \"price.png\")\npar(mfrow = c(1,2))\nhist(train_clean$price, breaks = 30)\nhist(log(train_clean$price), breaks = 30)\n```\n\n```{r correlation between variables, echo=FALSE}\nisNums = sapply(train_clean, is.numeric)\nM = cor(train_clean[, isNums])\npng(height=1200, width=1500, pointsize=15, filename = \"corr.png\")\ncorrplot(M, method=\"circle\", insig = \"blank\", tl.cex = 1/par(\"cex\"),\n    cl.cex = 1/par(\"cex\"), addCoefasPercent = TRUE)\n```\n\n```{r facet plot of Neighborhood}\nlibrary(ggplot2)\npng(height=600, width=1000, filename = \"facet.png\")\nggplot(data = train_clean, aes(x = area, y = price)) +\n  geom_point(alpha = 0.5) +\n  facet_wrap(~ Neighborhood)\n```\n\n```{r variable importance}\nmodel_rf = randomForest(log(price) ~., data = train_clean, mtry = 9, importance = T)\npng(width=900, pointsize=15, filename = \"rf_varImportance.png\")\nvarImpPlot(model_rf)\n\nmodel_boosting = gbm(log(price) ~., data = train_clean, distribution = \"gaussian\", n.trees = 30000,\n                     interaction.depth = 4)\npng(pointsize=15, filename = \"boosting_varImportance.png\")\nsummary(model_boosting)\n```\n\n## Fitting Models\n\n### Simple model\n\n1. OLS and BIC stepwise variable selection\n\n```{r ols with BIC}\n# ols\nmodel_ols = lm(log(price) ~ . , \n               data = train_clean[-c(168,183,462),])\nsummary(model_ols)\n\n# ols with BIC stepwise variable selection\nmodel_ols_bic = step(model_ols, k = log(nrow(train_clean)), trace = F)\nsummary(model_ols_bic)\n\n# rmse of training data\npredict_ols_bic_train = exp(model_ols_bic$fitted.values)\nrmse_ols_bic_train = RMSE(predict_ols_bic_train, train_clean[-c(168,183,462),]$price)\n\n# rmse and other statistics of testing data\npredict_ols_bic = predict(model_ols_bic, newdata = test_clean, interval = \"predict\")\npredict_ols_bic = exp(predict_ols_bic)\nrmse_ols_bic = RMSE(predict_ols_bic[1,], test_clean$price)\ncheck(predict_ols_bic, test_clean$price)\n# plot of prediction value and actual value of testing data\nplot(test_clean$price, predict_ols_bic[,1], )\nabline(a=0, b=1)\n\n# diagnostic plots of the BIC model\npar(mfrow=c(2,2))\nplot(model_ols_bic)\n# look at term plots of the BIC model for variable transformation\npar(mfrow=c(2,2))\ntermplot(model = model_ols_bic, partial.resid = T, se = T, rug = T, smooth = panel.smooth)\n```\n\n2. variable transformation based on BIC stepwise variable selection\n\n```{r ols trans x and y}\nmodel_ols_trans = lm(log(price) ~ \n                       area + log(Lot.Area + 1) + Neighborhood + Bldg.Type + \n                       Overall.Qual + Overall.Cond + \n                       Year.Built + \n                       # Year.Remod.Add + \n                       Bsmt.Exposure + BsmtFin.SF.1 + BsmtFin.SF.2 + Bsmt.Unf.SF +\n                       Central.Air + \n                       Kitchen.Qual + Functional + \n                       Fireplaces + \n                       Garage.Cars + \n                       # Garage.Area + \n                       Paved.Drive + Open.Porch.SF, \n                       #+ log(Enclosed.Porch + 1) + log(Screen.Porch + 1), \n                       data = train_clean[-c(168,183,462),])\npar(mfrow=c(2,2))\nplot(model_ols_trans)\n\n# RMSE on training data\npredict_ols_trans_train = exp(model_ols_trans$fitted.values)\nrmse_ols_trans_train = RMSE(predict_ols_trans_train, train_clean[-c(168,183,462),]$price)\n\n# rmse and other statistics on testing data\npredict_ols_trans = predict(model_ols_trans, newdata = test_clean, interval = \"predict\")\npredict_ols_trans = exp(predict_ols_trans)\nrmse_ols_trans = RMSE(predict_ols_trans[1,], test_clean$price)\ncheck(predict_ols_trans, test_clean$price)\n# plot of prediction value and actual value of testing data\nplot(test_clean$price, predict_ols_trans[,1] )\nabline(a=0, b=1)\n\npar(mfrow=c(2,2))\nplot(model_ols_trans)\n# termplot(model = model_ols_trans, partial.resid = T, se = T, rug = T, smooth = panel.smooth)\n```\n\n3. poisson regression\n\n```{r poisson}\nlibrary(MASS)\n\n#delete columns with colinearity and new levels\ndelete_list = c(16,74,46,48,39,23,24,25)\n\nmodel_poi =glm(price ~ .-PID, \n              data = train_clean[,-delete_list],family=\"poisson\")\n\nmodel_poi_bic = step(model_poi, k = log(nrow(train_clean)),trace = F)\n\npredict_poi_train = predict(model_poi_bic, newdata = train_clean)\npredict_poi_train = exp(predict_poi_train)\nrmse_pos_train = RMSE(predict_poi_train, train_clean$price)\ncheck(y_poi_train, train_clean$price)\n\npredict_poi_test = predict(model_poi_bic, newdata = test_clean)\npredict_poi_test = exp(predict_poi_test)\nrmse_poi_test = RMSE(predict_poi_test, test_clean$price)\ncheck(y_poi_test, test_clean$price)\n```\n\n4. boosting\n\n```{r boosting}\nlibrary(gbm)\nmodel_boosting = gbm(exp(price) ~ area + log(Lot.Area + 1) + Neighborhood + Bldg.Type + Overall.Qual +\n                       Overall.Cond + Year.Built + \n                       #Year.Remod.Add + \n                       Bsmt.Exposure + BsmtFin.SF.1 + \n                       BsmtFin.SF.2 + Bsmt.Unf.SF + Central.Air + Kitchen.Qual + Functional + \n                       Fireplaces + Garage.Cars + Garage.Area + Paved.Drive + Open.Porch.SF ,\n                       #log(Enclosed.Porch + 1) + log(Screen.Porch + 1), , \n                     data = train_clean[-c(168,183,462),], \n                     distribution = \"gaussian\",\n                     n.trees = 30000, \n                     interaction.depth = 4)\nsummary(model_boosting, plotit = F)\n\npredict_boosting = predict(model_boosting, newdata = test_clean, n.trees = 30000)\npredict_boosting = exp(predict_boosting)\n# how to compute prediction intervals for boosting?\nrmse_boosting = RMSE(predict_boosting, test_clean$price)\nrmse_boosting\nplot(test_clean$price, predict_boosting)\nabline(a=0, b=1)\n```\n\n5. random forest\n\n```{r random forest}\nlibrary(randomForest)\nmodel_rf = randomForest(log(price) ~ ., \n                        data = train_clean,\n                        mtry = sqrt(ncol(train_clean)),\n                        importance = T)\n# plot of random forest\nsummary(model_rf)\nmodel_rf\n# rmse of random forest\npredict_rf = predict(exp(model_rf), newdata = test_clean)\nrf_rmse = RMSE(predict_rf, ames_test_all$price)\nrf_rmse\n```\n\n6. lasso\n\n\n",
    "created" : 1493649621854.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1681384717",
    "id" : "2E719FB6",
    "lastKnownWriteTime" : 1493653534,
    "last_content_update" : 1493653534695,
    "path" : "~/STA521/FinalProject/analysis.Rmd",
    "project_path" : "analysis.Rmd",
    "properties" : {
        "last_setup_crc32" : "",
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}